version: 2

models:
  - name: fact_payments_daily_summary
    description: "Aggregated daily summary of payment transactions by country, product, and subscription type."
    columns:
      - name: summary_date
        description: "Date of the aggregated payments."
        tests:
          - not_null
      - name: billing_country
        description: "Country where the billing occurred."
        tests:
          - not_null
      - name: product
        description: "Subscription product level (PRO, GURU, BUSINESS)."
        tests:
          - not_null
      - name: product_level
        description: "Numeric representation of the product level."
        tests:
          - not_null
      - name: subscription_type
        description: "Type of subscription (Annual, Monthly, Other)."
        tests:
          - not_null
      - name: total_amount_paid_usd
        description: "Total actual amount paid in USD for the given day, country, product, and subscription type."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric
      - name: total_mrr_usd
        description: "Total Monthly Recurring Revenue (MRR) generated for the given day, country, product, and subscription type."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric
      - name: total_discount_usd
        description: "Total discount amount applied for the given day, country, product, and subscription type."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric
      - name: total_gross_amount_usd
        description: "Total gross amount (price * period) before discounts for the given day, country, product, and subscription type."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric
      - name: distinct_users
        description: "Count of distinct users who made payments for the given day, country, product, and subscription type."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: int64
      - name: total_transactions
        description: "Total number of transactions for the given day, country, product, and subscription type."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: int64

  - name: dim_user_subscriptions_history
    description: "Historical record of user subscription changes and events, including upgrades, downgrades, and new acquisitions. Provides a detailed view of user lifecycle."
    columns:
      - name: user_id
        description: "Unique identifier for the user."
        tests:
          - not_null
      - name: transaction_date
        description: "Date of the payment transaction."
        tests:
          - not_null
      - name: transaction_at
        description: "Timestamp of the payment transaction."
        tests:
          - not_null
      - name: product
        description: "Subscription product level at the time of transaction."
        tests:
          - not_null
      - name: product_level
        description: "Numeric representation of the product level at the time of transaction."
        tests:
          - not_null
      - name: amount_paid_usd
        description: "Amount paid for this specific transaction."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric
      - name: period
        description: "Duration of the subscription in months for this transaction."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: int64
      - name: mrr_per_transaction_usd
        description: "MRR generated by this specific transaction."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric
      - name: first_transaction_date
        description: "Date of the user's very first transaction."
        tests:
          - not_null
      - name: estimated_subscription_end_at
        description: "Estimated end timestamp of the subscription period for this transaction."
        tests:
          - not_null
      - name: previous_product
        description: "Product subscribed to before this transaction (NULL if first transaction)."
      - name: previous_product_level
        description: "Numeric level of the product subscribed to before this transaction (NULL if first transaction)."
      - name: next_transaction_at
        description: "Timestamp of the next transaction for this user (NULL if this is the last transaction)."
      - name: next_product
        description: "Product subscribed to after this transaction (NULL if this is the last transaction)."
      - name: next_product_level
        description: "Numeric level of the product subscribed to after this transaction (NULL if this is the last transaction)."
      - name: subscription_event_type
        description: "Categorization of the subscription event (e.g., 'New Acquisition', 'Upgrade', 'Downgrade', 'Renewal/Retention')."
        tests:
          - not_null
          - accepted_values:
              values: ['New Acquisition', 'Upgrade', 'Downgrade', 'Renewal/Retention', 'Other Event']
      - name: is_potential_churn_event_last_transaction
        description: "Boolean indicating if this is the last known transaction for a user and their estimated subscription period has ended, suggesting potential churn."
        tests:
          - not_null